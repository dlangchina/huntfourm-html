<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="apple-mobile-web-app-capable" content="no"><meta content="True" name="HandheldFriendly"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="google-site-verification" content="YRy3qLejfhrOT_FxPRQn2p5h_ykCLOmhpP3Q5QUWdHU"><link rel="icon" href="//l.ruby-china.com/photo/2016/c309db0b49cab85a32f756541ea0e2b0.png"><link rel="shortcut icon" href="./favicon.ico"><link href="./css/vendors.chunk.25f006b7.min.css" rel="stylesheet"><link href="./css/assets.chunk.b1fe8486.min.css" rel="stylesheet"><link href="./css/userCenter.c3e8ae80.min.css" rel="stylesheet"></head><body class="page-users" data-controller-name="users"><div class="header navbar navbar-expand flex-md-row bd-navbar"><div class="container d-sm-flex"><div class="navbar-header d-none d-md-flex" id="navbar-header" data-turbolinks-permanent><a href="./index.html" class="navbar-brand"><b>Dlang</b> China</a></div><div class="navbar-nav-scroll"><ul class="main-nav-menu navbar-nav d-flex"><li class="nav-item"><a class="nav-link active" href="./topics.html">社区</a></li><li class="nav-item"><a class="nav-link" href="./wiki.html">Wiki</a></li><li class="nav-gems nav-item d-none"><a href="https://gems.ruby-china.com" class="nav-link" target="_blank" rel="noopener">Gems</a></li></ul></div><div class="ml-auto d-md-flex"><form class="navbar-form d-none d-lg-flex mr-2 form-search active" action="/search" method="GET"><i class="fa btn-search fa-search"></i> <input class="form-control" name="q" type="text" value="" placeholder="搜索本站内容"></form><ul class="main-nav-menu navbar-nav align-items-center justify-content-end"><li class="nav-item"><a class="nav-link" href="./register.html">注册</a></li><li class="nav-item"><a class="nav-link" href="./login.html">登录</a></li></ul><ul class="nav navbar-nav align-items-center justify-content-end" style="margin-right: 15px"><li class="nav-item dropdown dropdown-avatar"><a href="#" class="dropdown-toggle nav-link" id="navbar-user-menu" data-toggle="dropdown" role="button" aria-expanded="false"><img class="media-object avatar-32" src="https://ruby-china.org/system/letter_avatars/2/C/187_101_202/64.png"> <span class="user-name">用户名</span></a><div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbar-user-menu"><a class="dropdown-item" href="./userCenter.html">captern</a><div class="dropdown-divider"></div><a class="dropdown-item" href="./setting.html">个人资料设置</a> <a class="dropdown-item" href="./favorites.html">我的收藏</a><div class="dropdown-divider"></div><a class="dropdown-item" rel="nofollow" data-method="delete" href="/account/sign_out">退出</a></div></li></ul></div></div></div><div id="main" class="main-container container"><div class="card crumbs-area"><div class="media clearfix"><ul class="breadcrumb" style="margin-top: 0;margin-bottom: 0; background: #ffffff"><li class="align-middle"><a href="#">Home</a></li><li><a href="#">2013</a></li><li class="active">十一月</li></ul></div></div><div class="row"><div class="sidebar col-md-3" id="sidebar"><div class="card profile"><div class="card-body"><div class="media"><div class="avatar media-left mr-3"><div class="image"><img class="media-object avatar-96" src="https://l.ruby-china.com/user/avatar/24967.jpg!lg"></div><div class="level"><span class="badge badge-info role">会员</span></div></div><div class="media-body"><div class="item">early (新手) <span class="opts pull-right"></span></div><div class="item number">第 24967 位会员 / <span title="注册日期">2016-02-14</span></div><div class="item counts"><span>15</span> 篇帖子 • <span>75</span> 条回帖</div><div class="item social"><a target="_blank" rel="nofollow" href="https://github.com/EarlyZhao"><i class="fa fa-github"></i></a> <a href="mailto: zhaowei5612@yeah.net"><i class="fa fa-envelope-o"></i></a></div></div></div><div class="buttons row"><div class="col-sm-6"><a title="" data-id="early" class="button-follow-user btn btn-primary btn-block" href="#"><i class="fa fa-user"></i> <span>关注</span></a></div><div class="col-sm-6"><a title="" data-id="early" class="button-block-user btn btn-default btn-block" href="#"><i class="fa fa-eye-slash"></i> <span>屏蔽</span></a></div></div><div class="tagline row">努力走向优雅、简洁、有逻辑地表达。</div><div class="buttons"></div></div></div><div class="card"><ul class="nav list-group" style="text-align: center"><li class="nav-item list-group-item active"><a href="#topics" class="nav-link active" data-toggle="tab">热门话题</a></li><li class="nav-item list-group-item"><a href="#replies" class="nav-link" data-toggle="tab">最近回帖</a></li><li class="nav-item list-group-item"><a href="#description" class="nav-link" data-toggle="tab">个人介绍</a></li></ul></div></div><div class="col-md-9"><div class="tabbable"><div class="tab-content"><div class="tab-pane active recent-topics" id="topics"><div class="card"><div class="card-header">热门话题</div><ul class="list-group list-group-flush"><li class="list-group-item"><div class="title"><a class="node" href="/topics/node2">Rails</a> <a title="五问 Sidekiq" href="/topics/36825">五问 Sidekiq</a> <i title="精华帖" class="fa fa-diamond" data-toggle="tooltip"></i></div><div class="info"><span class="counter">47 个赞 • 9 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node1">Ruby</a> <a title="Ruby 的好朋友 -- jemalloc" href="/topics/37699">Ruby 的好朋友 -- jemalloc</a> <i title="精华帖" class="fa fa-diamond" data-toggle="tooltip"></i></div><div class="info"><span class="counter">45 个赞 • 21 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node1">Ruby</a> <a title="Ruby GC 自述" href="/topics/37118">Ruby GC 自述</a> <i title="精华帖" class="fa fa-diamond" data-toggle="tooltip"></i></div><div class="info"><span class="counter">34 个赞 • 17 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node26">分享</a> <a title="图解 Unicorn 工作原理" href="/topics/37868">图解 Unicorn 工作原理</a> <i title="精华帖" class="fa fa-diamond" data-toggle="tooltip"></i></div><div class="info"><span class="counter">28 个赞 • 11 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node2">Rails</a> <a title="includes 的实现原理与困境" href="/topics/37245">includes 的实现原理与困境</a></div><div class="info"><span class="counter">19 个赞 • 8 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node68">翻译</a> <a title="Malloc 会加倍 Ruby 多线程应用的内存消耗" href="/topics/37073">Malloc 会加倍 Ruby 多线程应用的内存消耗</a></div><div class="info"><span class="counter">16 个赞 • 0 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node26">分享</a> <a title="Unicorn 进程如何保证平滑重启？" href="/topics/36935">Unicorn 进程如何保证平滑重启？</a> <i title="精华帖" class="fa fa-diamond" data-toggle="tooltip"></i></div><div class="info"><span class="counter">16 个赞 • 10 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node26">分享</a> <a title="RabbitMQ / Sneaker 工作方式简析" href="/topics/37587">RabbitMQ / Sneaker 工作方式简析</a> <i title="精华帖" class="fa fa-diamond" data-toggle="tooltip"></i></div><div class="info"><span class="counter">13 个赞 • 2 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node12">数据库</a> <a title="理解数据库事务" href="/topics/37420">理解数据库事务</a></div><div class="info"><span class="counter">9 个赞 • 0 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node26">分享</a> <a title="数据结构之 HashMap" href="/topics/36888">数据结构之 HashMap</a></div><div class="info"><span class="counter">9 个赞 • 10 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node27">瞎扯淡</a> <a title="从 ActiveRecord 看乐观锁" href="/topics/37161">从 ActiveRecord 看乐观锁</a></div><div class="info"><span class="counter">7 个赞 • 2 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node26">分享</a> <a title="数据结构之 stack/ 栈" href="/topics/37642">数据结构之 stack/ 栈</a></div><div class="info"><span class="counter">6 个赞 • 0 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node27">瞎扯淡</a> <a title="从上帝视角看微服务" href="/topics/37899">从上帝视角看微服务</a></div><div class="info"><span class="counter">4 个赞 • 5 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node68">翻译</a> <a title="你好，我是 PORO" href="/topics/34557">你好，我是 PORO</a></div><div class="info"><span class="counter">4 个赞 • 6 条回复</span></div></li><li class="list-group-item"><div class="title"><a class="node" href="/topics/node52">新手问题</a> <a title="HTTP 请求会被浏览器和服务器之外的其他地方缓存吗？" href="/topics/33574">HTTP 请求会被浏览器和服务器之外的其他地方缓存吗？</a></div><div class="info"><span class="counter">0 个赞 • 15 条回复</span></div></li></ul></div></div><div class="tab-pane recent-topics" id="replies"><div class="card"><div class="card-header">最近回帖</div><ul class="list-group list-group-flush recent-replies"><li class="list-group-item"><div class="title"><a href="/topics/37899">从上帝视角看微服务</a> <span class="info">at <abbr class="timeago" title="2018-12-20T18:49:02+08:00">2018年12月20日</abbr></span></div><div class="body markdown"><p>熵用来描述系统的混乱程度，是非常非常棒的一个概念。 说大点，脑力劳动所做的一切都是在减熵，减熵能力越强，所产生的价值越大，剩下的都是随时可替换的体力活，这是大部分只重视应用的码农的最终归宿。</p><p>自勉，希望多年以后我能真正在减熵的路上走好，而不是成为干体力活的“全栈工程师”。</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37899">从上帝视角看微服务</a> <span class="info">at <abbr class="timeago" title="2018-12-20T18:40:12+08:00">2018年12月20日</abbr></span></div><div class="body markdown"><p>所以说是 <code>递弱代偿</code>，要量力而行，选择当下合适的方案，逐步演化。（希望后面我真正开始完备实践的时候，能不激进踏实地这么走。）</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37899">从上帝视角看微服务</a> <span class="info">at <abbr class="timeago" title="2018-12-14T22:44:22+08:00">2018年12月14日</abbr></span></div><div class="body markdown"><p>文章关注本质，serviceMesh只是一种解耦的方式而已，是微服务理念的部分实践，相信随着技术发展，还会出现更多的解耦方式。</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37868">图解 Unicorn 工作原理</a> <span class="info">at <abbr class="timeago" title="2018-12-07T09:21:13+08:00">2018年12月07日</abbr></span></div><div class="body markdown"><p>golang是这样的。</p><ul><li>本身很快，可以自己做http协议解析</li><li>并发行好，accept得到一个新连接后，可以丢到一个gorouting里面执行socket操作和业务逻辑</li><li>gorouting本身很轻量，可以同时开非常多个，彼此之间可以实现并行执行</li></ul><p>到处都在处理error，所以程序的健壮性可以得到保障。 一般应用引入一个http包，就可以简单地实现应用服务器的功能了。</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37867">怎么在 sidekiq 中查看程序调用链？</a> <span class="info">at <abbr class="timeago" title="2018-12-06T22:11:59+08:00">2018年12月06日</abbr></span></div><div class="body markdown"><pre class="highlight ruby"><code><span class="nb">puts</span> <span class="nb">caller</span></code></pre></div></li><li class="list-group-item"><div class="title"><a href="/topics/37769">ActiveRecord 在 DB 服务中止重启后，无法自动重连</a> <span class="info">at <abbr class="timeago" title="2018-11-22T20:40:20+08:00">2018年11月22日</abbr></span></div><div class="body markdown"><p>这种方式要判断当前连接是否处于事务中，重连后原连接持有的锁等信息会被丢掉，如果应用程序还在按照事务进行操作的话可能会出问题。 <a href="https://dalibornasevic.com/posts/77-auto-reconnect-for-activerecord-connections" rel="nofollow" target="_blank">https://dalibornasevic.com/posts/77-auto-reconnect-for-activerecord-connections</a>， 建议楼主参考这个。</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37745">Friends don&#39;t let real friends use INT as a primary key?</a> <span class="info">at <abbr class="timeago" title="2018-11-09T14:08:26+08:00">2018年11月09日</abbr></span></div><div class="body markdown"><p>DHH在Railfconf2018中很自豪的说： “我们不招聘DBA，数据库不分库分表，只用一个主实例和其他slave， 怎么省事怎么来”</p><p>其实就是 Basecamp 量小，业务不够复杂而已。</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37699">Ruby 的好朋友 -- jemalloc</a> <span class="info">at <abbr class="timeago" title="2018-11-08T21:05:33+08:00">2018年11月08日</abbr></span></div><div class="body markdown"><p>这是用动态配置的方式让应用使用jemalloc吧，不想用时可以动态修改环境变量来控制。重新编译就没这个灵活性了。<a href="https://github.com/jemalloc/jemalloc/wiki/Getting-Started" rel="nofollow" target="_blank">https://github.com/jemalloc/jemalloc/wiki/Getting-Started</a></p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37733">求指教，关于冷热数据分离，各位大神们是如何在 Rails 中处理的？</a> <span class="info">at <abbr class="timeago" title="2018-11-07T19:33:31+08:00">2018年11月07日</abbr></span></div><div class="body markdown"><p>小规模数据可以这样：</p><ul><li>按照created_at分区(partition)。 例如三个月或一年一个区(看具体情况)，这个最简单。数据分布情况对应用透明，最近的查询会自动落到最新的分区上（得带上分区字段的查询条件）。</li><li>按照某字段分表。例如，可以是created_at，三个月或一年一个表(看具体情况)，分表的情况由应用自己维护。在查询时先按照created_at计算一下是在哪个表，然后就直接从对应表拿数据。</li></ul></div></li><li class="list-group-item"><div class="title"><a href="/topics/37699">Ruby 的好朋友 -- jemalloc</a> <span class="info">at <abbr class="timeago" title="2018-11-04T19:58:03+08:00">2018年11月04日</abbr></span></div><div class="body markdown"><p>我看到的解释和你接近。 对于jemalloc持谨慎态度的人一般是两个原因：</p><ul><li>要重新编译ruby(--with-jemalloc)，有人认为这可能会给复杂的生产环境带来潜在问题</li><li><a href="https://dzone.com/articles/linux-transparent-huge-pages">THP会使得jemalloc中的madvise失效，导致内存问题</a>，要安全使用jemolloc就得关闭THP</li></ul><p>对于glibc malloc，它为了减少多线程环境下，申请内存所产生的锁竞争，将可分配的arena数量放的比较大，这导致了严重的内存碎片，也是因为它本身不是为多线程环境而设计的。 将MALLOC_ARENA_MAX调小，可以减轻这种情况，但是会使得线程间的竞争变得严重，内存碎片是降低了，但是性能会受影响。</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37699">Ruby 的好朋友 -- jemalloc</a> <span class="info">at <abbr class="timeago" title="2018-11-01T22:25:34+08:00">2018年11月01日</abbr></span></div><div class="body markdown"><p>清洗是对于脏页(dirty page)进行的回收、合并等操作，是增加可用内存和减少碎片的操作，并不会有大量的内存移动之类的操作。 具体的过程有点复杂，可以参考下<a href="https://blog.csdn.net/vector03/article/details/50634802">附录中的这篇文章</a></p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37699">Ruby 的好朋友 -- jemalloc</a> <span class="info">at <abbr class="timeago" title="2018-11-01T13:21:48+08:00">2018年11月01日</abbr></span></div><div class="body markdown"><p><a href="http://engineering.appfolio.com/appfolio-engineering/2018/2/1/benchmarking-rubys-heap-malloc-tcmalloc-jemalloc" rel="nofollow" target="_blank">http://engineering.appfolio.com/appfolio-engineering/2018/2/1/benchmarking-rubys-heap-malloc-tcmalloc-jemalloc</a> 根据这篇文章的测试，性能有明显提升。</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/35515">Ruby 用 jemalloc 有什么坑么？</a> <span class="info">at <abbr class="timeago" title="2018-10-31T18:16:06+08:00">2018年10月31日</abbr></span></div><div class="body markdown"><p><a href="https://bugs.ruby-lang.org/issues/13899" rel="nofollow" target="_blank">https://bugs.ruby-lang.org/issues/13899</a></p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37699">Ruby 的好朋友 -- jemalloc</a> <span class="info">at <abbr class="timeago" title="2018-10-31T18:06:31+08:00">2018年10月31日</abbr></span></div><div class="body markdown"><p>已经在facebook上正常运行多年了，获得了广泛的认可。 这儿有个讨论帖 <a href="https://ruby-china.org/topics/35515" rel="nofollow" target="_blank">https://ruby-china.org/topics/35515</a></p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37688">为什么不应该使用 rvm/rbenv，以及替代方案</a> <span class="info">at <abbr class="timeago" title="2018-10-31T13:28:42+08:00">2018年10月31日</abbr></span></div><div class="body markdown"><p><a href="/ThxFly" class="user-mention" title="@ThxFly"><i>@</i>ThxFly</a> <a href="/Rei" class="user-mention" title="@Rei"><i>@</i>Rei</a> 感谢，我的说法有点问题。</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37688">为什么不应该使用 rvm/rbenv，以及替代方案</a> <span class="info">at <abbr class="timeago" title="2018-10-31T09:41:37+08:00">2018年10月31日</abbr></span></div><div class="body markdown"><p>Rails项目中ruby 版本和gemset大多可以自动切换，是不是痛点得据情况而定，一般在项目切换不频繁时，ruby版本不会是痛点。</p><p>Docker的本质是对运行环境进行隔离，主要价值在于可保证各个运行环境的一致性。 对于环境不一致导致的问题，其实也可以考虑打造一个 和生产环境高度一致的测试环境，在测试环境中暴露问题。一般由于环境不一致导致的问题，其实不会太频繁。 如果导致方案整体不可用的情况， 则可能方案的选择上欠考虑或者开发环境和生产环境差别过大。这其实也可以解决环境不一致带来的潜在问题，当然得根据情况而定。</p><p>在开发环境中用docker，除了环境一致性的优点外，其他的差不多可以视为缺点，带来反向价值。特别是对于像我等菜鸟，在开发时，经常拼错单词， 或者变量名取的不好要改，或者其他纰漏。这些小错在代码自动reload时，可以高效的解决。docker嘛，毕竟多了一层，<del>差不多活生生把动态语言开发搞成了静态语言开发，改一下还要构建一下</del>。是否值得选择，也得看自身情况。</p><p>至于用了docker是否区分Rails的三个模式，我实在想不出两者有什么关联。不用docker也不妨碍只用一种模式吧，只要你想。 用了docker，有多个模式也不会有问题。 关联何在？</p><p>以上是我的个人观点。</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37706">2018 中国 Matz 访谈视频</a> <span class="info">at <abbr class="timeago" title="2018-10-30T20:15:13+08:00">2018年10月30日</abbr></span></div><div class="body markdown"><p>很棒，值得一看。 直接点这个链接可进 <a href="https://v.qq.com/x/page/p0772tw9fij.html" rel="nofollow" target="_blank">https://v.qq.com/x/page/p0772tw9fij.html</a></p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37699">Ruby 的好朋友 -- jemalloc</a> <span class="info">at <abbr class="timeago" title="2018-10-30T14:51:24+08:00">2018年10月30日</abbr></span></div><div class="body markdown"><p>借<a href="/so_zengtao" class="user-mention" title="@so_zengtao"><i>@</i>so_zengtao</a>的风，来个完整的</p><p>Ubuntu MAC centos 安装jemalloc</p><pre class="highlight shell"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>libjemalloc-devbrew <span class="nb">install </span>jemalloc<span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> jemalloc jemalloc-devel</code></pre><p>rbenv</p><pre class="highlight shell"><code><span class="nv">RUBY_CONFIGURE_OPTS</span><span class="o">=</span><span class="nt">--with-jemalloc</span> rbenv <span class="nb">install </span>2.5.0</code></pre><p>rvm</p><pre class="highlight shell"><code>rvm reinstall 2.5.0 <span class="nt">--disable-binary</span> <span class="nt">--with-jemalloc</span></code></pre><p>源码安装</p><pre class="highlight shell"><code>./configure <span class="nt">--with-jemalloc</span>makemake <span class="nb">install</span></code></pre><p>检查安装是否正确</p><pre class="highlight shell"><code>ruby <span class="nt">-r</span> rbconfig <span class="nt">-e</span> <span class="s2">"puts RbConfig::CONFIG['LIBS']"</span><span class="c"># 应该输出：  -lpthread -ljemalloc -ldl -lobjc</span></code></pre></div></li><li class="list-group-item"><div class="title"><a href="/topics/37634">求解释， [a,b].max 比调用 max 函数快 </a><span class="info">at <abbr class="timeago" title="2018-10-18T09:46:51+08:00">2018年10月18日</abbr></span></div><div class="body markdown"><pre class="highlight ruby"><code><span class="mf">2.3</span><span class="o">.</span><span class="mi">6</span> <span class="p">:</span><span class="mo">021</span> <span class="o">&gt;</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'RUBY_VERSION'</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="s2">"ruby-2.3.6"</span><span class="o">.</span><span class="mf">3.6</span> <span class="p">:</span><span class="mo">01</span><span class="mi">9</span> <span class="o">&gt;</span>  <span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="p">{</span> <span class="n">maxa</span><span class="p">(</span><span class="mi">1000</span><span class="p">)}</span> <span class="o">=&gt;</span> <span class="c1">#&lt;Benchmark::Tms:0x00007f8a60a4a780 @label="", @real=2.4335659999924246, @cstime=0.0, @cutime=0.0, @stime=0.0, @utime=2.42, @total=2.42&gt;</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">6</span> <span class="p">:</span><span class="mo">020</span> <span class="o">&gt;</span> <span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="p">{</span> <span class="n">maxf</span><span class="p">(</span><span class="mi">1000</span><span class="p">)}</span> <span class="o">=&gt;</span> <span class="c1">#&lt;Benchmark::Tms:0x00007f8a60a3be88 @label="", @real=0.5101689999864902, @cstime=0.0, @cutime=0.0, @stime=0.0, @utime=0.5100000000000002, @total=0.5100000000000002&gt;</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'RUBY_VERSION'</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="s2">"ruby-2.5.0"</span> <span class="p">:</span><span class="mo">022</span> <span class="o">&gt;</span> <span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="p">{</span> <span class="n">maxa</span><span class="p">(</span><span class="mi">1000</span><span class="p">)}</span> <span class="o">=&gt;</span> <span class="c1">#&lt;Benchmark::Tms:0x00007fe484845d30 @label="", @real=0.46752000000560656, @cstime=0.0, @cutime=0.0, @stime=0.00017400000000000054, @utime=0.46631599999999995, @total=0.46648999999999996&gt;</span> <span class="p">:</span><span class="mo">023</span> <span class="o">&gt;</span> <span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="p">{</span> <span class="n">maxf</span><span class="p">(</span><span class="mi">1000</span><span class="p">)}</span> <span class="o">=&gt;</span> <span class="c1">#&lt;Benchmark::Tms:0x00007fe48282dc78 @label="", @real=0.6195719999959692, @cstime=0.0, @cutime=0.0, @stime=0.0003689999999999978, @utime=0.6181120000000001, @total=0.6184810000000001&gt;</span></code></pre><p>2.3 和2.5的测试，确实也是反过来的，而且差别不小。</p><p>我想说的是楼主的假设是不是不够科学？ [].max 虽然会返回新对象，但是它的执行成本明显要低于<code>max(a,b)</code>， 执行过程本身就会创建一大波对象(都放在ObjectSpace中的)，调用越少消耗越少，虽然栈调用的消耗相对较小。</p><p>不能简单地根据调用是否返回新对象来判断其性能吧？ <a href="/quakewang" class="user-mention" title="@quakewang"><i>@</i>quakewang</a></p><p>这个测试用例中被测试的调用是在each中的，不知道虚拟机解释的时候，是否有区别优化？</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37633">range 展开为何比 while 慢很多</a> <span class="info">at <abbr class="timeago" title="2018-10-17T09:31:50+08:00">2018年10月17日</abbr></span></div><div class="body markdown"><p>《Ruby原理剖析》里面介绍过，each 方法每次迭代都准备一大波对象，执行很多逻辑。而while只需要调整PC指针的值，性能不在一个量级。 具体的细节我得回去翻翻书了。</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37628">用 Docker 构建开发环境</a> <span class="info">at <abbr class="timeago" title="2018-10-16T18:28:39+08:00">2018年10月16日</abbr></span></div><div class="body markdown"><p>把第五步<code>how to use</code> 整理成一个脚本，在Dockerfile中用ENTRYPOINT/CMD触发， 再加上一个平滑替换容器的脚本， 就完美了。</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37629">基于 Postgres 实现一个热度算法</a> <span class="info">at <abbr class="timeago" title="2018-10-16T16:48:24+08:00">2018年10月16日</abbr></span></div><div class="body markdown"><p>Z-Score ML里面做数据特征归一化，数学真是无处不在</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37609">关于一些基础的语法问题</a> <span class="info">at <abbr class="timeago" title="2018-10-10T19:30:02+08:00">2018年10月10日</abbr></span></div><div class="body markdown"><pre class="highlight ruby"><code><span class="n">command</span> <span class="ss">:add</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>  <span class="n">c</span><span class="p">.</span><span class="nf">action</span> <span class="k">do</span> <span class="o">|</span><span class="n">global_options</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">args</span><span class="o">|</span>    <span class="vg">$todo_list</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="k">end</span><span class="k">end</span></code></pre><p>等价于：</p><pre class="highlight ruby"><code><span class="n">command</span><span class="p">(</span><span class="ss">:add</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>  <span class="n">c</span><span class="p">.</span><span class="nf">action</span> <span class="k">do</span> <span class="o">|</span><span class="n">global_options</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">args</span><span class="o">|</span>    <span class="vg">$todo_list</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="k">end</span><span class="k">end</span></code></pre><p><code>command(:add)</code> 会返回一个方法，后面的代码块是这个方法的"参数"。</p></div></li><li class="list-group-item"><div class="title"><a href="/topics/37426">部署程序如何能达到一定并发量？</a> <span class="info">at <abbr class="timeago" title="2018-09-04T10:16:20+08:00">2018年09月04日</abbr></span></div><div class="body markdown"><p>你nginx代理静态资源写的是这个：</p><pre class="highlight plaintext"><code>location ~*^/app/assets/{}</code></pre><p>有这个路径吗？换下下面这个试试：</p><pre class="highlight plaintext"><code>location ^~ /assets/{}</code></pre><p>顺便建议在 config/environments/production.rb 加上:</p><pre class="highlight ruby"><code><span class="n">config</span><span class="p">.</span><span class="nf">serve_static_files</span> <span class="o">=</span> <span class="kp">false</span> <span class="c1"># 不让后端处理静态资源请求，可以检测你nginx是否真的代理的静态资源</span></code></pre></div></li><li class="list-group-item"><div class="title"><a href="/topics/37346">关于 ElasticSearch 做查询时的简繁转换问题</a> <span class="info">at <abbr class="timeago" title="2018-08-18T12:58:19+08:00">2018年08月18日</abbr></span></div><div class="body markdown"><p>将 <code>精靈旅社</code>，<code>疯狂假期</code>, <code>精灵旅社</code> ， <code>精靈旅社</code> 在写入ES时，先全部转化为简体，只存一份。在查询时将所有的繁体转化为简体，再到ES查询，可行？</p></div></li></ul><div class="card-footer clearfix"><ul class="pagination"><li class="page-item active"><a remote="false" class="page-link">1</a></li><li class="page-item"><a rel="next" class="page-link" href="/early/replies?page=2">2</a></li><li class="page-item"><a class="page-link" href="/early/replies?page=3">3</a></li><li class="page-item next"><a rel="next" class="page-link" href="/early/replies?page=2">下一页 <i class="fa fa-angle-right"></i></a></li></ul></div></div></div><div class="tab-pane" id="description"><div class="card"><div class="card-header">个人介绍</div><div class="card-body markdown"><p>努力走向优雅、简洁、有逻辑地表达。</p></div></div></div></div></div></div></div></div><footer class="footer container"><div class="footer-menu footer"><ul class="pull-right"><li><a href="#">Back to top</a></li><li><a href="#">Back to top</a></li><li><a href="#">Back to top</a></li></ul><div class="pull-left"><div class="language-check" data-toggle="dropdown" role="button" aria-expanded="false"><a href="javascript:void(0);">选择语言</a></div><div class="dropdown-menu" aria-labelledby="navbar-user-menu"><a class="dropdown-item" href="./userCenter.html">中文</a><div class="dropdown-divider"></div><a class="dropdown-item" href="./setting.html">英文</a> <a class="dropdown-item" href="./favorites.html">发育</a><div class="dropdown-divider"></div><a class="dropdown-item" rel="nofollow" data-method="delete" href="/account/sign_out">退出</a></div></div></div><div class="footer-text"><div class="text-center footer">© 2017 CanvasFlip. <a data-ga="" data-ga-action="click" data-ga-category="copyright " data-ga-title="T&amp;C Lnk" href="tnc.php" target="_blank">Privacy Policy</a> &amp; <a href="tnc.php" target="_blank">Terms of Use</a></div></div></footer><script type="text/javascript" src="./js/vendors.chunk.92f95840438c1395b822.min.js"></script><script type="text/javascript" src="./js/assets.chunk.203f00000a79256faabe.min.js"></script><script type="text/javascript" src="./js/userCenter.5a09849c1e2ea33b3519.min.js"></script></body></html>